var T=Object.create;var m=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var x=s=>m(s,"__esModule",{value:!0});var F=(s,e)=>{for(var t in e)m(s,t,{get:e[t],enumerable:!0})},E=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Q(e))!$.call(s,i)&&(t||i!=="default")&&m(s,i,{get:()=>e[i],enumerable:!(n=M(e,i))||n.enumerable});return s},P=(s,e)=>E(x(m(s!=null?T(W(s)):{},"default",!e&&s&&s.__esModule?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s),R=(s=>(e,t)=>s&&s.get(e)||(t=E(x({}),e,1),s&&s.set(e,t),t))(typeof WeakMap!="undefined"?new WeakMap:0);var X={};F(X,{activate:()=>z});var c=P(require("vscode"));var o=P(require("vscode"));function y(s){for(;s.length;){let e=s.pop();e&&e.dispose()}}var C=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,y(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}};var _=class{constructor(){this._webviews=new Set}*get(e){let t=e.toString();for(let n of this._webviews)n.resource===t&&(yield n.webviewPanel)}has(e){return!this.get(e).next().done}add(e,t){let n={resource:e.toString(),webviewPanel:t};this._webviews.add(n),t.onDidDispose(()=>{this._webviews.delete(n)})}};var d=class extends C{constructor(e,t,n){super();this._edits=[];this._savedEdits=[];this.pathRegExp=/(?<dirname>.*)\/(?<filename>(?<basename>.*)(?<extname>\.[^.]+))$/;this._onDidDispose=this._register(new o.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidChangeDocument=this._register(new o.EventEmitter);this.onDidChangeContent=this._onDidChangeDocument.event;this._onDidChange=this._register(new o.EventEmitter);this.onDidChange=this._onDidChange.event;this._uri=e,this._documentData=t,this._delegate=n}static async create(e,t,n){let i=typeof t=="string"?o.Uri.parse(t):e,a=await d.readFile(i);return new d(e,a,n)}static async readFile(e){return e.scheme==="untitled"?new Uint8Array:o.workspace.fs.readFile(e)}get uri(){return this._uri}get uriParts(){let{dirname:e,filename:t,basename:n,extname:i}=this._uri.toString().match(this.pathRegExp)?.groups??{};return{dirname:e,filename:t,basename:n,extname:i}}get documentData(){return this._documentData}dispose(){this._onDidDispose.fire(),super.dispose()}makeEdit(e){this._edits.push(e),this._onDidChange.fire({label:"Stroke",undo:async()=>{this._edits.pop(),this._onDidChangeDocument.fire({edits:this._edits})},redo:async()=>{this._edits.push(e),this._onDidChangeDocument.fire({edits:this._edits})}})}async save(e){await this.saveAs(this.uri,e),this._savedEdits=Array.from(this._edits)}async saveAs(e,t){let n=await this._delegate.getFileData();t.isCancellationRequested||await o.workspace.fs.writeFile(e,n)}async revert(e){let t=await d.readFile(this.uri);this._documentData=t,this._edits=this._savedEdits,this._onDidChangeDocument.fire({content:t,edits:this._edits})}async refresh(e){let t=await d.readFile(this.uri);this._documentData=t,this._edits=[],this._onDidChangeDocument.fire({content:t,edits:[]})}async backup(e,t){return await this.saveAs(e,t),{id:e.toString(),delete:async()=>{try{await o.workspace.fs.delete(e)}catch{}}}}},q="default-src",I="script-src",j="style-src",O="img-src",B="font-src",H="child-src",u="'self'",p="vscode-resource: qwtel.vscode-unpkg.net",V="data:",N="blob:",J="'unsafe-inline'",K="'unsafe-eval'",Y=s=>Object.entries(s).map(([e,t])=>`${e} ${t.join(" ")};`).join(" "),U=class{constructor(e){this._context=e;this.webviews=new _;this._onDidChangeCustomDocument=new o.EventEmitter;this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event;this._requestId=1;this._callbacks=new Map}async openCustomDocument(e,t,n){let i=await d.create(e,t.backupId,{getFileData:async()=>{let r=[...this.webviews.get(i.uri)];if(!r.length)throw new Error("Could not find webview to save for");let l=r[0],v=await this.postMessageWithResponse(l,"getFileData",{});return new Uint8Array(v)}}),a=[];return a.push(i.onDidChange(r=>{this._onDidChangeCustomDocument.fire({document:i,...r})})),a.push(i.onDidChangeContent(r=>{for(let l of this.webviews.get(i.uri)){let{filename:v}=i.uriParts,{buffer:h,byteOffset:f,byteLength:L}=i.documentData,A={buffer:h,byteOffset:f,byteLength:L};this.postMessage(l,"update",{filename:v,value:A,editable:!1},[h])}})),i.onDidDispose(()=>y(a)),i}async resolveCustomEditor(e,t,n){this.webviews.add(e.uri,t),t.webview.options={enableScripts:!0},t.webview.html=await this.getHtmlForWebview(t.webview),t.webview.onDidReceiveMessage(i=>this.onMessage(e,i)),t.webview.onDidReceiveMessage(i=>{if(i.type==="ready"&&this.webviews.has(e.uri))if(e.uri.scheme==="untitled")this.postMessage(t,"init",{filename:"untitled",untitled:!0,editable:!1});else{let{buffer:r,byteOffset:l,byteLength:v}=e.documentData,h={buffer:r,byteOffset:l,byteLength:v},{filename:f}=e.uriParts;this.postMessage(t,"init",{filename:f,value:h,editable:!1},[r])}})}saveCustomDocument(e,t){return e.save(t)}saveCustomDocumentAs(e,t,n){return e.saveAs(t,n)}revertCustomDocument(e,t){return e.revert(t)}backupCustomDocument(e,t,n){return e.backup(t.destination,n)}async getHtmlForWebview(e){let t=o.Uri.joinPath(this._context.extensionUri,"sqlite-viewer-app","public"),n=o.Uri.joinPath(this._context.extensionUri,"node_modules","@vscode/codicons","dist","codicon.css"),i=new TextDecoder().decode(await o.workspace.fs.readFile(o.Uri.joinPath(t,"vscode.html"))),a=e.asWebviewUri(o.Uri.joinPath(this._context.extensionUri,"sqlite-viewer-app","public")).toString(),r={[q]:[u,p],[I]:[u,p,K],[j]:[u,p,J],[O]:[u,p,V],[B]:[u,p],[H]:[N]};return i.replaceAll("%PUBLIC_URL%",a).replaceAll("%REACT_APP_CSP%",Y(r)).replace("<!--HEAD-->",`
        <link rel="stylesheet" href="${e.asWebviewUri(o.Uri.joinPath(t,"bundle.css"))}"/>
        <link rel="stylesheet" href="${e.asWebviewUri(n)}"/>
      `).replace("<!--BODY-->",`
        <script src="${e.asWebviewUri(o.Uri.joinPath(t,"bundle.js"))}"><\/script>
      `)}postMessageWithResponse(e,t,n){let i=this._requestId++,a=new Promise(r=>this._callbacks.set(i,r));return e.webview.postMessage({type:t,requestId:i,body:n}),a}postMessage(e,t,n,i){e.webview.postMessage({type:t,body:n},i)}async onMessage(e,t){switch(t.type){case"refresh":e.uri.scheme!=="untitled"&&e.refresh();return;case"blob":let{data:n,download:i,metaKey:a}=t,{dirname:r}=e.uriParts,l=o.Uri.parse(`${r}/${i}`);await o.workspace.fs.writeFile(l,n),a||await o.commands.executeCommand("vscode.open",l);return;case"response":{this._callbacks.get(t.requestId)?.(t.body);return}}}},S={webviewOptions:{retainContextWhenHidden:!0},supportsMultipleEditorsPerDocument:!1},D=class extends U{static register(e){return o.window.registerCustomEditorProvider(D.viewType,new D(e),S)}},b=D;b.viewType="sqlite-viewer.view";var g=class extends U{static register(e){return o.window.registerCustomEditorProvider(g.viewType,new g(e),S)}},w=g;w.viewType="sqlite-viewer.option";function z(s){G(s),s.subscriptions.push(b.register(s)),s.subscriptions.push(w.register(s))}var k="qwtel.sqlite-viewer";async function G(s){let e=s.globalState.get(k),t=c.extensions.getExtension(k).packageJSON.version;if(s.globalState.update(k,t),e===void 0||e!==t||s.extensionMode===c.ExtensionMode.Development){let n,i=await c.window.showInformationMessage("Minor bug fixes and updated SQLite to 3.38.0. SQLite Viewer Web now supports Drag & Drop.",...n=[{title:"Try SQLite Viewer Web \u2197"}]);i!==null&&i===n[0]&&await c.env.openExternal(c.Uri.parse("https://sqliteviewer.app?ref=vscode"))}}module.exports=R(X);
